lua_shared_dict ip_cache 1m;

init_worker_by_lua_block {
    local function get_preferred_ip()
        local handle = io.popen("ip -4 addr show eth0 | grep -oP '(?<=inet\\s)\\d+(\\.\\d+){3}' 2>/dev/null")
        local ip = handle:read("*a"):gsub("%s+", "")
        handle:close()
        if ip ~= "" then return ip end

        handle = io.popen("ip -4 addr show wlan0 | grep -oP '(?<=inet\\s)\\d+(\\.\\d+){3}' 2>/dev/null")
        ip = handle:read("*a"):gsub("%s+", "")
        handle:close()
        if ip ~= "" then return ip end

        handle = io.popen("ip -4 addr show usb0 | grep -oP '(?<=inet\\s)\\d+(\\.\\d+){3}' 2>/dev/null")
        ip = handle:read("*a"):gsub("%s+", "")
        handle:close()
        if ip ~= "" then return ip end

        return nil
    end

    local function update_ip()
        local new_ip = get_preferred_ip()
        if not new_ip then
            ngx.log(ngx.WARN, "No valid IP found on eth0/wlan0/usb0")
            return
        end
        local old_ip = ngx.shared.ip_cache:get("server_ip")
        if old_ip ~= new_ip then
            ngx.shared.ip_cache:set("server_ip", new_ip)
            ngx.log(ngx.NOTICE, "Server IP updated to: " .. new_ip .. " (priority: eth0 > wlan0 > usb0)")
        end
    end

    update_ip()

    local ok, err = ngx.timer.every(30, update_ip)
    if not ok then
        ngx.log(ngx.ERR, "Failed to create timer: ", err)
    end
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    server_name _;

    location / {
        content_by_lua_block {
            local ip = ngx.shared.ip_cache:get("server_ip")
            if ip then
                ngx.redirect("http://" .. ip .. ":3001", 301)
            else
                ngx.status = 503
                ngx.say("Server IP not available yet")
                ngx.exit(ngx.HTTP_SERVICE_UNAVAILABLE)
            end
        }
    }

    location /dashboard {
        content_by_lua_block {
            local function get_product_name()
                local path = "/home/gadgetini/gadgetini/src/display/config.ini"
                local file = io.open(path, "r")
                if not file then
                    ngx.log(ngx.WARN, "Cannot open config.ini at " .. path)
                    return "unknown"
                end

                local name
                for line in file:lines() do
                    line = line:match("^%s*(.-)%s*$") or ""
                    if line == "" or line:match("^#") or line:match("^;") then
                        goto continue
                    end

                    local value = line:match("^name%s*=%s*(.+)$")
                    if value then
                        name = value:match("^%s*(.-)%s*$") or value
                        break
                    end

                    ::continue::
                end
                file:close()
                return name or "unknown"
            end

            local prod_name = get_product_name()
            local ip = ngx.shared.ip_cache:get("server_ip")

            if not ip then
                ngx.status = 503
                ngx.say("Server IP not available yet")
                ngx.exit(ngx.HTTP_SERVICE_UNAVAILABLE)
            end

            local dashboards = {
                ["dg5r"] = "/d/dg5R-dashboard-v1/dg5r-dashboard",
                ["dg5w"] = "/d/dg5W-dashboard-v1/dg5w-dashboard",
            }

            local path = dashboards[prod_name]
            if not path then
                ngx.log(ngx.WARN, "Unknown product name: " .. prod_name)
                ngx.status = 404
                ngx.say("No dashboard configured for product: " .. prod_name)
                ngx.exit(ngx.HTTP_NOT_FOUND)
            end

            ngx.redirect("http://" .. ip .. ":3000" .. path .. "?orgId=1&refresh=10s&kiosk", 301)
        }
    }
}
